// Human Benchmark Chimp Test ìë™ í´ë¦­ JavaScript ì½”ë“œ
// DOMì„ ì§€ì†ì ìœ¼ë¡œ ê°ì‹œí•´ì„œ ìˆ«ìë“¤ì„ ìë™ìœ¼ë¡œ í´ë¦­í•©ë‹ˆë‹¤
// ë§¤ ë¼ìš´ë“œë§ˆë‹¤ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  ì§„í–‰í•©ë‹ˆë‹¤
// ê°™ì€ ìˆ«ìëŠ” ì ˆëŒ€ ì¤‘ë³µ í´ë¦­í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
// ê°œë°œì ë„êµ¬ Consoleì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”

let isRunning = false;
let lastRoundCount = 0;
let observer = null;
let isClicking = false; // í˜„ì¬ í´ë¦­ ì‘ì—… ì¤‘ì¸ì§€ í™•ì¸
let clickedElements = new Set(); // í´ë¦­í•œ ìš”ì†Œë“¤ì„ ì¶”ì 

async function findAndClickNumbers() {
    // ì´ë¯¸ í´ë¦­ ì‘ì—… ì¤‘ì´ë©´ ìŠ¤í‚µ
    if (isClicking) {
        return;
    }

    // í˜„ì¬ í™”ë©´ì—ì„œ ìˆ«ìê°€ ìˆëŠ” ìš”ì†Œë“¤ì„ ì°¾ê¸°
    const numberElements = Array.from(document.querySelectorAll('.w-16.h-16')).filter(el => {
        const text = el.textContent.trim();
        return text && !isNaN(text) && text !== '';
    });

    // ìƒˆë¡œìš´ ë¼ìš´ë“œê°€ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (numberElements.length === 0 || numberElements.length === lastRoundCount) {
        return; // ìˆ«ìê°€ ì—†ê±°ë‚˜ ì´ì „ê³¼ ê°™ìœ¼ë©´ ìŠ¤í‚µ
    }

    // í´ë¦­ ì‘ì—… ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •
    isClicking = true;

    lastRoundCount = numberElements.length;

    // ìƒˆë¡œìš´ ë¼ìš´ë“œê°€ ì‹œì‘ë˜ë©´ ì´ì „ í´ë¦­ ê¸°ë¡ ì´ˆê¸°í™”
    clickedElements.clear();
    console.log(`ğŸ”¢ ìƒˆë¡œìš´ ë¼ìš´ë“œ ê°ì§€! ${numberElements.length}ê°œì˜ ìˆ«ì ë°œê²¬ (ì´ì „ ê¸°ë¡ ì´ˆê¸°í™”ë¨)`);

    await new Promise(resolve => setTimeout(resolve, 2));

    // ìˆ«ì ìˆœì„œëŒ€ë¡œ ì •ë ¬
    numberElements.sort((a, b) => {
        const numA = parseInt(a.textContent.trim());
        const numB = parseInt(b.textContent.trim());
        return numA - numB;
    });

    console.log('ğŸ“‹ í´ë¦­ ìˆœì„œ:', numberElements.map(el => el.textContent.trim()).join(' â†’ '));

    // í˜„ì¬ ë¼ìš´ë“œì˜ ì´ ìˆ«ì ê°œìˆ˜ë§Œí¼ ìˆœì„œëŒ€ë¡œ í´ë¦­
    for (let currentNumber = 1; currentNumber <= numberElements.length; currentNumber++) {
        // ì´ë¯¸ í´ë¦­í•œ ìˆ«ìì¸ì§€ í™•ì¸
        if (clickedElements.has(currentNumber)) {
            console.log(`â­ï¸ ${currentNumber}ë²ˆì€ ì´ë¯¸ í´ë¦­ë¨ - ìŠ¤í‚µ`);
            continue;
        }

        // í˜„ì¬ ìˆ«ìì— í•´ë‹¹í•˜ëŠ” ìš”ì†Œ ì°¾ê¸° (í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸° ë˜ëŠ” í¬ì§€ì…˜ìœ¼ë¡œ ì¶”ì •)
        let targetElement = null;

        // 1. ë¨¼ì € í…ìŠ¤íŠ¸ë¡œ ì°¾ê¸° (ì•„ì§ í…ìŠ¤íŠ¸ê°€ ë‚¨ì•„ìˆëŠ” ê²½ìš°)
        targetElement = numberElements.find(el => {
            const text = el.textContent.trim();
            return text && parseInt(text) === currentNumber;
        });

        // 2. í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ì €ì¥ëœ ìš”ì†Œë“¤ì—ì„œ ì°¾ê¸°
        if (!targetElement) {
            // numberElements ë°°ì—´ì—ì„œ currentNumberë²ˆì§¸ ìš”ì†Œ ì‚¬ìš©
            const elementIndex = currentNumber - 1;
            if (elementIndex < numberElements.length) {
                targetElement = numberElements[elementIndex];
            }
        }

        if (targetElement) {
            console.log(`ğŸ–±ï¸ ${currentNumber}ë²ˆ í´ë¦­ ì¤‘...`);

            // í´ë¦­í•œ ìˆ«ìë¡œ ë§ˆí¬
            clickedElements.add(currentNumber);

            // ìš”ì†Œ í´ë¦­
            targetElement.click();

            // ë‹¤ìŒ ìˆ«ìê¹Œì§€ ë”œë ˆì´
            if (currentNumber < numberElements.length) {
                await new Promise(resolve => setTimeout(resolve, 2)); // 300ms ë”œë ˆì´
            }
        } else {
            console.log(`âŒ ${currentNumber}ë²ˆ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
        }
    }

    console.log('âœ… ë¼ìš´ë“œ ì™„ë£Œ! ë‹¤ìŒ ë¼ìš´ë“œ ëŒ€ê¸° ì¤‘...');

    // í´ë¦­ ì‘ì—… ì™„ë£Œ í”Œë˜ê·¸ í•´ì œ
    isClicking = false;
}

function startObserver() {
    if (observer) {
        observer.disconnect();
    }

    // DOM ë³€ê²½ì„ ê°ì‹œí•˜ëŠ” ì˜µì €ë²„ ìƒì„±
    observer = new MutationObserver(async (mutations) => {
        if (!isRunning) return;

        // DOM ë³€ê²½ì´ ê°ì§€ë˜ë©´ ìˆ«ì ì°¾ê¸° ì‹œë„
        await findAndClickNumbers();
    });

    // body ìš”ì†Œì˜ ë³€ê²½ì‚¬í•­ì„ ê°ì‹œ
    observer.observe(document.body, {
        childList: true,
        subtree: true,
        characterData: true
    });

    console.log('ğŸ‘ï¸ DOM ë³€ê²½ ê°ì‹œ ì‹œì‘...');
}

function startAutoClicker() {
    if (isRunning) {
        console.log('âš ï¸ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!');
        return;
    }

    isRunning = true;
    console.log('ğŸš€ Chimp Test ìë™ í´ë¦­ ì‹œì‘! DOMì„ ê°ì‹œí•©ë‹ˆë‹¤...');
    console.log('ğŸ’¡ ê²Œì„ì´ ì§„í–‰ë˜ëŠ” ë™ì•ˆ ìë™ìœ¼ë¡œ ìˆ«ìë“¤ì„ í´ë¦­í•©ë‹ˆë‹¤');
    console.log('ğŸ›‘ ì¤‘ë‹¨í•˜ë ¤ë©´: stopAutoClicker() ì…ë ¥');

    // DOM ì˜µì €ë²„ ì‹œì‘
    startObserver();
}

function stopAutoClicker() {
    isRunning = false;
    isClicking = false;
    lastRoundCount = 0;
    clickedElements.clear(); // í´ë¦­í•œ ìˆ«ìë“¤ ì´ˆê¸°í™”

    if (observer) {
        observer.disconnect();
        observer = null;
    }

    console.log('â¹ï¸ ìë™ í´ë¦­ ì¤‘ë‹¨ë¨');
}

// ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (Consoleì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
window.startAutoClicker = startAutoClicker;
window.stopAutoClicker = stopAutoClicker;

// ìë™ ì‹œì‘
startAutoClicker();